<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebAR with Screenshot</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 999;
    }
    .ar-button {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
    }
    .screenshot-button {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      display: none; /* Start AR時に表示 */
    }
  </style>
</head>
<body>
  <div id="overlay"></div>

  <!-- Three.js and VRM libraries omitted for brevity -->

  <button id="startArButton" class="ar-button">Start AR</button>
  <button id="screenshotButton" class="screenshot-button">Take Screenshot</button>

  <script>
    const startArButton = document.getElementById('startArButton');
    const screenshotButton = document.getElementById('screenshotButton');

    let vrm;

    // Three.js setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.xr.enabled = true;
    renderer.xr.setReferenceSpaceType('local');
    document.body.appendChild(renderer.domElement);

    async function arButtonClick() {
      startArButton.style.display = 'none'; // Hide start button
      screenshotButton.style.display = 'block'; // Show screenshot button

      const overlayElem = document.getElementById('overlay');
      const options = {
        requiredFeatures: ['hit-test'],
        optionalFeatures: ['dom-overlay'],
        domOverlay: { root: overlayElem }
      };
      const xrSession = await navigator.xr.requestSession('immersive-ar', options);
      await renderer.xr.setSession(xrSession);

      animate();
    }

    startArButton.addEventListener('click', arButtonClick);

    // Add screenshot functionality
    screenshotButton.addEventListener('click', () => {
      renderer.render(scene, camera);
      const screenshot = renderer.domElement.toDataURL('image/png');

      // Create a link and simulate a click to download the image
      const link = document.createElement('a');
      link.href = screenshot;
      link.download = 'screenshot.png';
      link.click();
    });

    function animate() {
      renderer.setAnimationLoop(render);
    }

    function render(timestamp, frame) {
      if (frame) {
        renderer.render(scene, camera);
      }
    }
  </script>
</body>
</html>
