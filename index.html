<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebAR test</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 999;
    }
    /* ボタンのスタイル */
    .pose-button {
      position: absolute;
      bottom: 80px;
      z-index: 1000;
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="overlay"></div>

  <!-- ボタンの追加 -->
  <button id="pose1" class="pose-button" style="left: 10%;">Pose 1</button>
  <button id="pose2" class="pose-button" style="left: 30%;">Pose 2</button>
  <button id="pose3" class="pose-button" style="left: 50%;">Pose 3</button>
  <button id="pose4" class="pose-button" style="left: 70%;">Pose 4</button>

  <!-- Three.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- WebXR Polyfill (for browsers that do not fully support WebXR) -->
  <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>
  <!-- GLTFLoader for loading VRM models -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <!-- VRM libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@0.6.0"></script>

  <script>
    let vrmModel = null; // VRMモデルを保持する変数

    // WebARサポートの判定
    (async () => {
      const isArSupported = navigator.xr && (await navigator.xr.isSessionSupported('immersive-ar'));

      if (isArSupported) {
        const button = document.createElement('button');
        button.innerText = 'Start AR';
        button.style.position = 'absolute';
        button.style.bottom = '20px';
        button.style.left = '50%';
        button.style.transform = 'translateX(-50%)';
        button.style.zIndex = '1000';
        document.body.appendChild(button);

        button.addEventListener('click', arButtonClick);
      } else {
        alert('WebAR is not supported on this device');
      }
    })();

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(
      70,
      window.innerWidth / window.innerHeight,
      0.01,
      20
    );
    const light = new THREE.DirectionalLight(0xffffff);
    light.position.set(1, 1, 1).normalize();
    scene.add(light);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);
    renderer.xr.enabled = true;
    renderer.xr.setReferenceSpaceType('local');

    const controller = renderer.xr.getController(0);
    controller.addEventListener('select', onSelect);
    scene.add(controller);

    const reticle = new THREE.Mesh(
      new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
      new THREE.MeshBasicMaterial()
    );
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    let hitTestSource = null;

    async function arButtonClick() {
      const overlayElem = document.getElementById('overlay');
      const options = {
        requiredFeatures: ['hit-test'],
        optionalFeatures: ['dom-overlay'],
        domOverlay: { root: overlayElem }
      };
      const xrSession = await navigator.xr.requestSession('immersive-ar', options);
      await renderer.xr.setSession(xrSession);
      animate();
    }

    function animate() {
      renderer.setAnimationLoop(render);
    }

    async function render(timestamp, frame) {
      if (!frame) return;

      const referenceSpace = renderer.xr.getReferenceSpace();
      const session = renderer.xr.getSession();
      if (!hitTestSource && referenceSpace && session) {
        const space = await session.requestReferenceSpace('viewer');
        hitTestSource = await session.requestHitTestSource({ space });

        session.addEventListener('end', () => {
          hitTestSource = null;
        });
      }
      if (hitTestSource) {
        const hitTestResults = frame.getHitTestResults(hitTestSource);
        if (hitTestResults.length && referenceSpace) {
          const hit = hitTestResults[0];
          reticle.visible = true;
          reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
        } else {
          reticle.visible = false;
        }
      }

      renderer.render(scene, camera);
    }

    async function onSelect() {
      if (reticle.visible) {
        const loader = new THREE.GLTFLoader();
        const gltf = await loader.loadAsync('./AliciaSolid.vrm');
        THREE.VRMUtils.removeUnnecessaryJoints(gltf.scene);
        vrmModel = await THREE.VRM.from(gltf);

        reticle.matrix.decompose(
          vrmModel.scene.position,
          vrmModel.scene.quaternion,
          vrmModel.scene.scale,
        );
        vrmModel.scene.rotation.y = camera.rotation.y + Math.PI;
        vrmModel.lookAt.target = camera;
        scene.add(vrmModel.scene);
        reticle.visible = false;
      }
    }

    // ポーズ変更関数
    function setPose(poseNumber) {
      if (vrmModel) {
        // ポーズごとのボーンの姿勢を設定（例として適当な設定を入れています）
        switch (poseNumber) {
          case 1:
            vrmModel.humanoid.getBoneNode("leftUpperArm").rotation.set(0,0,0.2104997822744993,0.9775939042682235); // Pose 1
            vrmModel.humanoid.getBoneNode("leftLowerArm").rotation.set(0,0,0.1966939546310881,0.9804649347180059); // Pose 1
            vrmModel.humanoid.getBoneNode("rightUpperArm").rotation.set(0.0008382054128868589,0.000042215752234726076,0.5319047403303575,0.8468037806030456); // Pose 1
            vrmModel.humanoid.getBoneNode("rightHand").rotation.set(0,0,0.2962018416322877,0.9551253682180372); // Pose 1
            break;
          case 2:
            vrmModel.humanoid.getBoneNode("Hips").rotation.set(0.3, 0.5, 0); // Pose 2
            break;
          case 3:
            vrmModel.humanoid.getBoneNode("Hips").rotation.set(-0.3, -0.5, 0); // Pose 3
            break;
          case 4:
            vrmModel.humanoid.getBoneNode("Hips").rotation.set(0, 0, 0.5); // Pose 4
            break;
        }
      }
    }

    // ボタンのイベントリスナー追加
    document.getElementById('pose1').addEventListener('click', () => setPose(1));
    document.getElementById('pose2').addEventListener('click', () => setPose(2));
    document.getElementById('pose3').addEventListener('click', () => setPose(3));
    document.getElementById('pose4').addEventListener('click', () => setPose(4));
  </script>
</body>
</html>
